<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Employee Productivity Predictor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .spinner-border {
      display: none;
      width: 3rem;
      height: 3rem;
    }
    .result-img {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
    }
    #featureInputs input {
      margin-bottom: 10px;
    }
    #predict-section {
      margin-top: 30px;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="card shadow-lg">
    <div class="card-body">
      <h1 class="card-title text-center mb-4">Employee Productivity Predictor</h1>

      <h5>1. Upload Dataset (CSV)</h5>
      <input class="form-control" type="file" id="fileUpload">
      <button class="btn btn-primary mt-3 w-100" onclick="uploadFile()">Upload & Train Models</button>
      <div class="d-flex justify-content-center mt-3">
        <div class="spinner-border text-primary" id="uploadSpinner" role="status"></div>
      </div>

      <div id="results-section" class="mt-4">
        <h5 class="mb-3">2. Training Results</h5>
        <div id="comparisonTable" class="table-responsive"></div>
      </div>

      <!-- Prediction Section -->
      <div id="predict-section" style="display:none;">
        <hr/>
        <h5 class="mb-3">3. Make a Prediction</h5>

        <label for="modelSelect" class="form-label">Select Model:</label>
        <select class="form-select" id="modelSelect">
          <option value="Linear Regression">Linear Regression</option>
          <option value="Random Forest">Random Forest</option>
          <option value="XGBoost">XGBoost</option>
        </select>

        <div id="featureInputs" class="mt-3"></div>
        <button class="btn btn-success mt-3 w-100" onclick="makePrediction()">Predict</button>
        <div class="d-flex justify-content-center mt-3">
          <div class="spinner-border text-success" id="predictSpinner" role="status"></div>
        </div>

        <div class="alert alert-info mt-3">
          <strong>Prediction Result:</strong>
          <div id="prediction" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let featureNames = [];

function uploadFile() {
  const file = document.getElementById("fileUpload").files[0];
  if (!file) {
    alert("Please select a file.");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);

  document.getElementById("uploadSpinner").style.display = "inline-block";

  fetch("/upload", { method: "POST", body: formData })
    .then(response => response.json())
    .then(data => {
      document.getElementById("uploadSpinner").style.display = "none";
      featureNames = data.features;

      // Build comparison table
      const results = data.results;
      let tableHtml = `<table class="table table-bordered table-striped">
                        <thead class="table-light"><tr><th>Model</th><th>MAE</th><th>RMSE</th><th>RÂ²</th></tr></thead><tbody>`;
      for (const model in results) {
        const metrics = results[model];
        tableHtml += `<tr>
                        <td>${model}</td>
                        <td>${metrics.MAE.toFixed(3)}</td>
                        <td>${metrics.RMSE.toFixed(3)}</td>
                        <td>${metrics.R2.toFixed(3)}</td>
                      </tr>`;
      }
      tableHtml += "</tbody></table>";

      // Add charts
      tableHtml += `<h5 class="mt-4">Visual Comparison</h5>
                    <img class="result-img" src="data:image/png;base64,${data.bar_chart}">
                    <h5 class="mt-4">Correlation Heatmap</h5>
                    <img class="result-img" src="data:image/png;base64,${data.heatmap}">`;

      document.getElementById("comparisonTable").innerHTML = tableHtml;

      // Create feature input fields
      const container = document.getElementById("featureInputs");
      container.innerHTML = "";
      featureNames.forEach(name => {
        const input = document.createElement("input");
        input.type = "number";
        input.step = "any";
        input.placeholder = name;
        input.id = "feat_" + name;
        input.className = "form-control";
        container.appendChild(input);
      });

      document.getElementById("predict-section").style.display = "block";
    })
    .catch(err => {
      document.getElementById("uploadSpinner").style.display = "none";
      alert("Error uploading file: " + err);
    });
}

function makePrediction() {
  const model = document.getElementById("modelSelect").value;
  const features = {};
  for (const name of featureNames) {
    const val = parseFloat(document.getElementById("feat_" + name).value);
    if (isNaN(val)) {
      alert("Please fill all feature fields.");
      return;
    }
    features[name] = val;
  }

  document.getElementById("predictSpinner").style.display = "inline-block";

  fetch("/predict", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ model: model, features: features })
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById("predictSpinner").style.display = "none";
    document.getElementById("prediction").innerText =
        "Predicted productivity: " + data.prediction.toFixed(2);
  })
  .catch(err => {
    document.getElementById("predictSpinner").style.display = "none";
    alert("Error making prediction: " + err);
  });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
